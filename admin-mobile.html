
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>台中簡媽媽狗園｜手機版後台</title>
<style>
:root { --green:#497f54; --mint:#9ed2a3; --danger:#b00020; }
body { margin:0; font-family:'Noto Sans TC',system-ui; background:#f8f9f7; color:#333; }
header { background:var(--mint); color:#fff; padding:.8rem 1rem; display:flex; justify-content:space-between; align-items:center; }
header h1 { font-size:1.05rem; margin:0; }
button,select,input,textarea { font-size:1rem; border-radius:8px; border:1px solid #ccc; padding:.6rem; width:100%; box-sizing:border-box; }
button { background:var(--green); color:#fff; border:none; margin-top:.6rem; }
button:disabled { opacity:.6; }
.card { background:#fff; border-radius:10px; margin:1rem; padding:1rem; box-shadow:0 2px 6px rgba(0,0,0,.08); }
.thumb { width:80px; height:80px; border-radius:8px; overflow:hidden; position:relative; background:#eee; }
.thumb img { width:100%; height:100%; object-fit:cover; }
.thumb b { position:absolute; top:2px; right:6px; background:rgba(0,0,0,.6); color:#fff; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; }
.flex { display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.5rem; }
.table { width:100%; border-collapse:collapse; }
th,td { border-bottom:1px solid #eee; padding:.5rem; text-align:left; }
.danger { background:var(--danger); color:#fff; border:none; padding:.4rem .8rem; border-radius:8px; }
footer { background:var(--green); color:#fff; text-align:center; padding:1rem; font-size:.9rem; }
</style>
<script>
if (window.innerWidth > 768) {
  window.location.href = "admin.html";
}
</script>
</head>
<body>
<header>
  <h1>台中簡媽媽狗園｜手機版後台</h1>
  <button id="logoutBtn">登出</button>
</header>

<section class="card">
  <h3>新增動物</h3>
  <label>名字</label><input id="name">
  <label>類別</label><select id="group"><option value="cat">貓</option><option value="dog">狗</option></select>
  <label>次類別</label><select id="subGroup"></select>
  <label>品種／毛色</label><select id="breed"></select>
  <label>年齡</label><input id="age" placeholder="幾歲或幾個月">
  <label>性別</label><select id="gender"><option>男生</option><option>女生</option></select>
  <label>介紹</label><textarea id="intro"></textarea>
  <label>上傳圖片（最多 6 張）</label>
  <input id="photos" type="file" accept="image/*" multiple>
  <div id="previews" class="flex"></div>
  <button id="saveBtn">登錄</button>
</section>

<section class="card">
  <h3>已登錄動物</h3>
  <input id="search" placeholder="搜尋名字...">
  <table class="table"><thead><tr><th>名字</th><th>性別</th><th>操作</th></tr></thead><tbody id="list"></tbody></table>
  <div id="empty" style="display:none;color:#666;padding:.6rem 0">查無此動物</div>
</section>

<footer>© 2025 台中簡媽媽狗園｜手機後台</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig={apiKey:"AIzaSyADseNNkszDTbwEk4F03_rC0fo4Rnk0iBM",authDomain:"pet-adoption-32294.firebaseapp.com",projectId:"pet-adoption-32294",storageBucket:"pet-adoption-32294.firebasestorage.app",messagingSenderId:"102978803311",appId:"1:102978803311:web:a7d890096b2b23cad15f9a"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

// 白名單帳號
const ALLOWED_EMAILS=["tonyj0721@gmail.com"];

// 登入檢查
onAuthStateChanged(auth,user=>{
  if(!user){alert("請先登入");location.href="login.html";return;}
  if(!ALLOWED_EMAILS.includes(user.email)){alert("此帳號無權限");signOut(auth);return;}
});

// 登出
document.getElementById('logoutBtn').onclick=()=>{signOut(auth);location.href="login.html";};

// 自動登出
let timer;const AUTO_LOGOUT_MS=10*60*1000;
function resetTimer(){clearTimeout(timer);timer=setTimeout(async()=>{await signOut(auth);alert("已自動登出");location.href="login.html";},AUTO_LOGOUT_MS);}
['click','touchstart','scroll','keydown'].forEach(e=>document.addEventListener(e,resetTimer));resetTimer();

// DOM 與資料操作
const $=s=>document.querySelector(s);
let files=[],allPets=[],deleteTarget=null;
const previews=$('#previews'),list=$('#list'),empty=$('#empty');

const breedSets={cat:{pure:["美短","英短","藍貓","暹羅貓"],mix:["橘貓","黑貓","虎斑貓","三花貓","白貓"]},dog:{pure:["博美","貴賓","馬爾濟斯","柴犬","黃金獵犬"],mix:["黑色","白色","棕色","花花","虎斑"]}};
function updateSubGroup(){const g=$('#group').value,s=$('#subGroup');s.innerHTML=g==='cat'?'<option value="pure">品種貓</option><option value="mix">米克斯</option>':'<option value="pure">品種犬</option><option value="mix">米克斯</option>';updateBreed();}
function updateBreed(){const g=$('#group').value,sg=$('#subGroup').value,b=$('#breed');b.innerHTML='';breedSets[g][sg].forEach(x=>{const o=document.createElement('option');o.textContent=x;b.appendChild(o);});}
$('#group').onchange=updateSubGroup;$('#subGroup').onchange=updateBreed;updateSubGroup();

$('#photos').onchange=e=>{files=[...e.target.files].slice(0,6);renderPreviews();};
function renderPreviews(){previews.innerHTML='';files.forEach((f,i)=>{const box=document.createElement('div');box.className='thumb';const img=new Image();img.src=URL.createObjectURL(f);box.appendChild(img);const del=document.createElement('b');del.textContent='×';del.onclick=()=>{files.splice(i,1);renderPreviews();};box.appendChild(del);previews.appendChild(box);});}

async function compress(file){const bmp=await createImageBitmap(file);const s=Math.min(1,1280/bmp.width);const c=document.createElement('canvas');c.width=bmp.width*s;c.height=bmp.height*s;c.getContext('2d').drawImage(bmp,0,0,c.width,c.height);const blob=await new Promise(r=>c.toBlob(r,'image/jpeg',0.85));return new File([blob],file.name,{type:'image/jpeg'});}
async function uploadImages(fs,id){const out=[];let i=0;for(const f of fs){const cf=await compress(f);const p=`images/pets/${id}/${Date.now()}-${i++}.jpg`;const r=ref(storage,p);await uploadBytes(r,cf);const url=await getDownloadURL(r);out.push({url,path:p});}return out;}

async function loadList(){const q=query(collection(db,'pets'),orderBy('createdAt','desc'));const qs=await getDocs(q);allPets=qs.docs.map(d=>({id:d.id,...d.data()}));renderList(allPets);}
function renderList(items){list.innerHTML='';items.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.name}</td><td>${p.gender}</td><td><button class='danger' data-id='${p.id}'>刪除</button></td>`;list.appendChild(tr);});list.querySelectorAll('.danger').forEach(b=>b.onclick=()=>del(b.dataset.id));empty.style.display=items.length?'none':'';}
async function del(id){if(!confirm("確定刪除？"))return;const pet=allPets.find(x=>x.id===id);if(pet?.images){for(const im of pet.images){try{await deleteObject(ref(storage,im.path));}catch{}}}await deleteDoc(doc(db,'pets',id));await loadList();}

$('#saveBtn').onclick=async()=>{const name=$('#name').value.trim();if(!name){alert("請輸入名字");return;}const refCol=collection(db,'pets');const exist=await getDocs(query(refCol,where('name','==',name)));if(!exist.empty){if(!confirm("此名字已存在，要繼續嗎？"))return;}const data={name,species:$('#group').value,breed:$('#breed').value,age:$('#age').value,gender:$('#gender').value,intro:$('#intro').value,createdAt:Date.now()};const docRef=await addDoc(refCol,data);const imgs=await uploadImages(files,docRef.id);await updateDoc(docRef,{images:imgs});alert("登錄成功");files=[];previews.innerHTML='';$('#name').value='';$('#age').value='';$('#intro').value='';await loadList();};

$('#search').oninput=e=>{const t=e.target.value.trim().toLowerCase();const f=allPets.filter(p=>p.name.toLowerCase().includes(t));renderList(f);if(!f.length){empty.style.display='block';}};
loadList();
</script>
</body>
</html>
