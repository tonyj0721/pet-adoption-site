<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>台中簡媽媽狗園｜手機版後台</title>

<style>
:root{
  --green:#497f54; --mint:#9ed2a3; --danger:#d32f2f;
  --ink:#333; --bg:#f8f9f7; --card:#fff; --muted:#666;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Sans TC",system-ui,-apple-system; background:var(--bg); color:var(--ink)}
header{background:var(--mint); color:#fff; padding:.8rem 1rem; display:flex; align-items:center; justify-content:space-between}
header h1{margin:0; font-size:1.05rem}
button,input,select,textarea{font-size:1rem}
.btn{background:var(--green); color:#fff; border:0; padding:.7rem 1rem; border-radius:10px}
.btn:disabled{opacity:.6}
.card{background:var(--card); border-radius:12px; margin:1rem; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.08)}
label{display:block; font-size:.95rem; margin:.2rem 0 .3rem}
input,select,textarea{width:100%; padding:.65rem; border:1px solid #ccc; border-radius:10px; margin-bottom:.75rem}

/* 列表卡片 */
.pet-card{background:#fff; border:1px solid #e9e9e9; border-radius:12px; margin-bottom:.9rem; overflow:hidden}
.pet-main{padding:1rem}
.pet-main b{font-size:1.05rem}
.pet-pairs{display:flex; flex-wrap:wrap; gap:.35rem .9rem; margin-top:.35rem; color:#444}
.pet-pairs span{display:inline-flex; gap:.35rem; align-items:center; font-size:.93rem}
.pet-meta{color:#555; font-size:.9rem}
.pet-expand{display:none; border-top:1px dashed #eee; padding:1rem; position:relative}
.pet-card.open .pet-expand{display:block}
.gallery{display:flex; gap:.5rem; overflow-x:auto; padding:.25rem 0}
.thumb{width:92px; height:92px; border-radius:10px; overflow:hidden; background:#eee; flex:0 0 auto}
.thumb img{width:100%; height:100%; object-fit:cover}

/* 浮動小圓圖示 */
.iconbar{position:absolute; top:.65rem; right:.65rem; display:flex; gap:.45rem}
.fab{width:36px; height:36px; border-radius:999px; display:grid; place-items:center; color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.22); transform:translateZ(0); transition:transform .12s ease, opacity .12s ease}
.fab:active{transform:scale(.94)}
.fab.red{background:var(--danger)}
.fab.green{background:var(--green)}
.close-fab{position:absolute; top:.65rem; left:.65rem; width:36px; height:36px; border-radius:999px; display:grid; place-items:center; color:#fff; background:rgba(0,0,0,.35); backdrop-filter:saturate(140%) blur(4px); box-shadow:0 2px 6px rgba(0,0,0,.18)}
.icon{width:20px; height:20px}

/* 放大圖 Modal */
.modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50}
.modal.open{display:flex}
.modal-inner{position:relative; max-width:90vw; max-height:86vh}
.modal-inner img{max-width:90vw; max-height:86vh; border-radius:8px}
.modal-close{position:absolute; top:-10px; right:-10px}

/* 編輯視窗 */
.sheet{position:fixed; left:0; right:0; bottom:0; background:#fff; border-radius:16px 16px 0 0;
       box-shadow:0 -6px 18px rgba(0,0,0,.25); transform:translateY(100%); transition:transform .2s ease; z-index:60; max-height:88vh; overflow:auto}
.sheet.open{transform:translateY(0)}
.sheet header{position:sticky; top:0; background:#fff; color:#222; padding:1rem; border-bottom:1px solid #eee}
.sheet .body{padding:1rem}

/* 桌機導回 */
@media(min-width:769px){ body{display:none} }
</style>

<script>
// 桌機導回後台桌機版
if (window.innerWidth > 768) { location.href = "admin.html"; }
// 未登入導回 login（沿用你原本的 sessionStorage 判斷）
if (sessionStorage.getItem('loggedIn') !== '1') { location.href = "login.html"; }
</script>
</head>

<body>
<header>
  <h1>台中簡媽媽狗園｜手機版後台</h1>
  <button id="logoutBtn" class="btn">登出</button>
</header>

<!-- 新增區 -->
<section class="card">
  <h3>新增動物</h3>
  <label>名字</label><input id="name">
  <label>類別</label>
  <select id="species">
    <option value="狗">狗</option>
    <option value="貓">貓</option>
  </select>
  <label>品種</label><input id="breed">
  <label>年齡</label><input id="age" placeholder="例如：3歲 / 9個月">
  <label>性別</label>
  <select id="gender"><option>男生</option><option>女生</option></select>
  <label>介紹</label><textarea id="intro" rows="3"></textarea>
  <label>上傳圖片（最多 6 張）</label>
  <input id="photos" type="file" accept="image/*" multiple>
  <button id="saveBtn" class="btn">登錄</button>
</section>

<!-- 清單 -->
<section class="card">
  <h3>已登錄動物</h3>
  <input id="search" placeholder="搜尋名字..." />
  <div id="list"></div>
  <div id="empty" style="display:none;color:#666;padding:.6rem 0">查無此動物</div>
</section>

<footer class="card" style="text-align:center;background:var(--green);color:#fff">
  © 2025 台中簡媽媽狗園｜手機後台
</footer>

<!-- 圖片預覽 Modal -->
<div id="imgModal" class="modal" aria-hidden="true">
  <div class="modal-inner">
    <img id="modalImg" alt="預覽">
    <button id="imgClose" class="fab modal-close" title="關閉" style="background:rgba(0,0,0,.55)">
      <!-- X -->
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
  </div>
</div>

<!-- 編輯 Sheet -->
<div id="editSheet" class="sheet" aria-hidden="true">
  <header>
    <b>編輯動物資料</b>
  </header>
  <div class="body">
    <input type="hidden" id="editId">
    <label>名字</label><input id="e_name">
    <label>類別</label>
    <select id="e_species"><option>狗</option><option>貓</option></select>
    <label>品種</label><input id="e_breed">
    <label>年齡</label><input id="e_age">
    <label>性別</label>
    <select id="e_gender"><option>男生</option><option>女生</option></select>
    <label>介紹</label><textarea id="e_intro" rows="3"></textarea>

    <div style="margin:.6rem 0 .2rem;color:#444">已上傳圖片（勾選欲刪除）</div>
    <div id="e_gallery" class="gallery"></div>

    <label style="margin-top:.8rem">新增圖片（可多選，總數以 6 張為上限）</label>
    <input id="e_files" type="file" accept="image/*" multiple>

    <div style="display:flex; gap:.6rem; margin-top:1rem">
      <button id="editSave" class="btn" style="flex:1">儲存變更</button>
      <button id="editCancel" class="btn" style="flex:1; background:#777">取消</button>
    </div>
  </div>
</div>

<script type="module">
/* ===== Firebase 初始化 ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyADseNNkszDTbwEk4F03_rC0fo4Rnk0iBM",
  authDomain: "pet-adoption-32294.firebaseapp.com",
  projectId: "pet-adoption-32294",
  storageBucket: "pet-adoption-32294.firebasestorage.app",
  messagingSenderId: "102978803311",
  appId: "1:102978803311:web:a7d890096b2b23cad15f9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const stg = getStorage(app);

/* ===== 登出（清掉 sessionStorage） ===== */
document.getElementById('logoutBtn').onclick = ()=>{
  sessionStorage.removeItem('loggedIn');
  location.href = 'login.html';
};

/* ===== 新增資料 ===== */
let createFiles = [];
document.getElementById('photos').onchange = e => createFiles = [...e.target.files].slice(0,6);

async function uploadImages(files, id){
  const out = [];
  let i=0;
  for(const f of files){
    const path = `images/pets/${id}/${Date.now()}-${i++}-${f.name}`;
    const r = ref(stg, path);
    await uploadBytes(r, f);
    out.push({ url: await getDownloadURL(r), path });
  }
  return out;
}

document.getElementById('saveBtn').onclick = async ()=>{
  const data = {
    name:   document.getElementById('name').value.trim(),
    species:document.getElementById('species').value,
    breed:  document.getElementById('breed').value.trim(),
    age:    document.getElementById('age').value.trim(),
    gender: document.getElementById('gender').value,
    intro:  document.getElementById('intro').value.trim(),
    createdAt: Date.now()
  };
  if(!data.name){ alert("請輸入名字"); return; }
  const refCol = collection(db,"pets");
  const dref = await addDoc(refCol, data);
  const imgs = await uploadImages(createFiles, dref.id);
  if(imgs.length) await updateDoc(dref, { images: imgs });
  createFiles = [];
  document.getElementById('photos').value="";
  ['name','breed','age','intro'].forEach(id=>document.getElementById(id).value="");
  loadList();
  alert("登錄成功");
};

/* ===== 讀取與渲染清單 ===== */
let all = [];
const listEl = document.getElementById('list');
const emptyEl= document.getElementById('empty');

async function loadList(){
  const qy = query(collection(db,"pets"), orderBy("createdAt","desc"));
  const snap = await getDocs(qy);
  all = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  render(all);
}

function render(items){
  listEl.innerHTML = "";
  emptyEl.style.display = items.length ? "none":"block";
  items.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'pet-card';
    card.dataset.id = p.id;

    // 主區塊（名字、類別、品種、年齡、性別）
    card.innerHTML = `
      <div class="pet-main">
        <b>${p.name || '未命名'}</b>
        <div class="pet-pairs" style="margin-top:.4rem">
          <span>類別：${p.species || '-'}</span>
          <span>品種：${p.breed || '-'}</span>
          <span>年齡：${p.age || '-'}</span>
          <span>性別：${p.gender || '-'}</span>
        </div>
      </div>
      <div class="pet-expand">
        <button class="close-fab" title="關閉">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
        <div class="iconbar">
          <button class="fab red del-btn" title="刪除">
            <!-- 垃圾桶（經典） -->
            <svg class="icon" viewBox="0 0 24 24" fill="#fff"><path d="M3 6h18v2H3V6zm2 3h14v13H5V9zm5 3v7h2v-7h-2zm4 0v7h2v-7h-2zM9 4V2h6v2h5v2H4V4h5z"/></svg>
          </button>
          <button class="fab green edit-btn" title="編輯">
            <!-- 鉛筆 -->
            <svg class="icon" viewBox="0 0 24 24" fill="#fff"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>
          </button>
        </div>

        <div class="pet-meta" style="margin-top:.2rem">介紹：</div>
        <div style="white-space:pre-wrap; color:#444; margin:.25rem 0 .6rem">${p.intro || '（無）'}</div>

        <div class="pet-meta" style="margin:.2rem 0 .25rem">圖片：</div>
        <div class="gallery">
          ${ (p.images||[]).map(im=>`
            <div class="thumb"><img src="${im.url}" alt="image"></div>
          `).join('') || '<div style="color:#888">尚無圖片</div>'}
        </div>
      </div>
    `;

    // 事件：點主卡片 展開/收合
    card.querySelector('.pet-main').addEventListener('click', ()=> card.classList.toggle('open'));
    // 關閉鈕
    card.querySelector('.close-fab').addEventListener('click', (e)=>{ e.stopPropagation(); card.classList.remove('open'); });
    // 刪除
    card.querySelector('.del-btn').addEventListener('click', async (e)=>{
      e.stopPropagation();
      if(!confirm('確定要刪除這筆資料嗎？')) return;
      // 先刪 Storage 圖
      if(p.images && p.images.length){
        for(const im of p.images){
          try{ await deleteObject(ref(stg, im.path)); }catch{}
        }
      }
      await deleteDoc(doc(db,"pets",p.id));
      card.remove();
      if(!listEl.children.length) emptyEl.style.display='block';
    });
    // 編輯
    card.querySelector('.edit-btn').addEventListener('click', (e)=>{ e.stopPropagation(); openEditor(p); });

    // 圖片放大
    card.querySelectorAll('.thumb img').forEach(img=>{
      img.addEventListener('click', (e)=>{
        e.stopPropagation();
        openPreview(img.src);
      });
    });

    listEl.appendChild(card);
  });
}

/* ===== 搜尋（依名字） ===== */
document.getElementById('search').oninput = e=>{
  const t = e.target.value.trim().toLowerCase();
  const f = all.filter(x => (x.name||'').toLowerCase().includes(t));
  render(f);
};

/* ===== 圖片預覽 ===== */
const imgModal = document.getElementById('imgModal');
const modalImg = document.getElementById('modalImg');
document.getElementById('imgClose').onclick = ()=> imgModal.classList.remove('open');
imgModal.addEventListener('click', e=>{ if(e.target===imgModal) imgModal.classList.remove('open'); });
function openPreview(src){ modalImg.src = src; imgModal.classList.add('open'); }

/* ===== 編輯功能 ===== */
const sheet = document.getElementById('editSheet');
const e_id = document.getElementById('editId');
const e_name = document.getElementById('e_name');
const e_species=document.getElementById('e_species');
const e_breed=document.getElementById('e_breed');
const e_age  =document.getElementById('e_age');
const e_gender=document.getElementById('e_gender');
const e_intro=document.getElementById('e_intro');
const e_gallery=document.getElementById('e_gallery');
const e_files = document.getElementById('e_files');

let galleryToDelete = new Set();

function openEditor(p){
  galleryToDelete = new Set();
  e_id.value = p.id;
  e_name.value = p.name || '';
  e_species.value = p.species || '狗';
  e_breed.value = p.breed || '';
  e_age.value = p.age || '';
  e_gender.value = p.gender || '男生';
  e_intro.value = p.intro || '';

  // 已有圖片（可勾選刪除）
  e_gallery.innerHTML = (p.images||[]).map((im,idx)=>`
    <label style="position:relative">
      <input type="checkbox" data-path="${im.path}" style="position:absolute;left:6px;top:6px;z-index:2;transform:scale(1.2)">
      <div class="thumb"><img src="${im.url}"></div>
    </label>
  `).join('') || '<div style="color:#888">尚無圖片</div>';

  e_gallery.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
    chk.addEventListener('change', e=>{
      if(chk.checked) galleryToDelete.add(chk.dataset.path);
      else galleryToDelete.delete(chk.dataset.path);
    });
  });

  e_files.value = "";
  sheet.classList.add('open');
}
document.getElementById('editCancel').onclick = ()=> sheet.classList.remove('open');

document.getElementById('editSave').onclick = async ()=>{
  const id = e_id.value;
  const dref = doc(db,"pets",id);

  // 1) 刪除勾選的舊圖
  if(galleryToDelete.size){
    const pet = all.find(x=>x.id===id);
    const keep = (pet.images||[]).filter(im=> !galleryToDelete.has(im.path));
    for(const path of galleryToDelete){
      try{ await deleteObject(ref(stg, path)); }catch{}
    }
    await updateDoc(dref, { images: keep });
  }

  // 2) 上傳新圖（若有）
  const addFiles = [...e_files.files];
  if(addFiles.length){
    const appended = await uploadImages(addFiles, id);
    const pet = all.find(x=>x.id===id);
    const cur = (pet.images||[]).filter(im=> !galleryToDelete.has(im.path));
    await updateDoc(dref, { images: [...cur, ...appended] });
  }

  // 3) 更新欄位
  await updateDoc(dref, {
    name: e_name.value.trim(),
    species: e_species.value,
    breed: e_breed.value.trim(),
    age: e_age.value.trim(),
    gender: e_gender.value,
    intro: e_intro.value.trim()
  });

  sheet.classList.remove('open');
  await loadList();
  alert("已更新");
};

/* ===== 啟動 ===== */
loadList();
</script>
</body>
</html>
