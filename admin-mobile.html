<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>台中簡媽媽狗園｜手機版後台</title>

<style>
:root{
  --green:#497f54; --mint:#9ed2a3; --danger:#d32f2f;
  --ink:#333; --muted:#666; --line:#e6e6e6;
  --bg:#f8f9f7; --card:#fff;
}
*{box-sizing:border-box}
html,body{margin:0; padding:0; background:var(--bg); color:var(--ink); font-family:"Noto Sans TC",system-ui,-apple-system;}
/* header */
header{background:var(--mint); color:#fff; padding:.8rem 1rem; display:flex; align-items:center; justify-content:space-between}
header h1{margin:0; font-size:1.05rem}
.btn{background:var(--green); color:#fff; border:0; padding:.7rem 1rem; border-radius:10px}
.btn:disabled{opacity:.6; cursor:not-allowed}

.card{background:var(--card); border-radius:12px; margin:1rem; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.08)}
label{display:block; font-size:.95rem; margin:.2rem 0 .35rem}
input,select,textarea{width:100%; padding:.65rem .7rem; border:1px solid #ccc; border-radius:10px; margin-bottom:.75rem; background:#f8f9f7}

/* list (single line) */
.list-row{display:flex; gap:.6rem; align-items:center; justify-content:space-between; padding:.8rem .6rem; border-bottom:1px solid var(--line); background:#fff; border-radius:10px; margin-bottom:.6rem}
.row-main{display:flex; gap:.8rem; align-items:center; flex-wrap:wrap}
.row-main b{font-size:1rem}
.badge{font-size:.86rem; color:#444; background:#f2f3f2; padding:.25rem .5rem; border-radius:999px;}

/* modal (follow index.html style: center panel with overlay) */
.modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:50}
.modal.open{display:grid}
.panel{width:min(900px,92vw); max-height:88vh; background:#fff; border-radius:16px; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.25); position:relative}
.panel-head{position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; padding:1rem 1rem 1rem 3.2rem}
.panel-title{font-weight:700; font-size:1.1rem}
.panel-body{padding:1rem}
.gallery{display:flex; gap:.6rem; overflow:auto; padding:.2rem 0}
.thumb{width:110px; height:110px; border-radius:10px; overflow:hidden; background:#eee; flex:0 0 auto}
.thumb img{width:100%; height:100%; object-fit:cover}

/* circular icon buttons (top corners) */
.fab{width:38px; height:38px; border-radius:50%; display:grid; place-items:center; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,.25); border:0}
.fab:active{transform:scale(.95)}
.fab-gray{background:rgba(0,0,0,.35); backdrop-filter:saturate(140%) blur(4px)}
.fab-red{background:var(--danger)}
.fab-green{background:var(--green)}
.icon{width:20px; height:20px}

.left-top{position:absolute; left:.8rem; top:.8rem}
.right-top{position:absolute; right:.8rem; top:.8rem; display:flex; gap:.5rem}

/* image preview modal */
.preview{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; place-items:center; z-index:60}
.preview.open{display:grid}
.preview img{max-width:92vw; max-height:88vh; border-radius:10px}
.preview .close{position:absolute; top:1rem; right:1rem}

/* editor small sheet */
.sheet{position:fixed; left:0; right:0; bottom:0; background:#fff; border-radius:16px 16px 0 0; box-shadow:0 -8px 24px rgba(0,0,0,.25); transform:translateY(100%); transition:transform .2s ease; z-index:70; max-height:88vh; overflow:auto}
.sheet.open{transform:translateY(0)}
.sheet header{position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; padding:1rem}
.sheet .body{padding:1rem}
.sheet .row{display:grid; grid-template-columns:1fr 1fr; gap:.8rem}
.sheet .actions{display:flex; gap:.6rem}

/* footer */
footer{background:var(--green); color:#fff; text-align:center; padding:1rem; border-radius:12px; margin:1rem}

/* redirect to desktop */
@media(min-width:769px){ body{display:none} }
</style>

<script>
// 桌機導回
if (window.innerWidth > 768) location.href = "admin.html";
// 未登入導回（沿用你的 sessionStorage 登入）
if (sessionStorage.getItem('loggedIn') !== '1') location.href = "login.html";
</script>
</head>

<body>
<header>
  <h1>台中簡媽媽狗園｜手機版後台</h1>
  <button id="logoutBtn" class="btn">登出</button>
</header>

<!-- 新增 -->
<section class="card">
  <h3>新增動物</h3>

  <label>名字</label>
  <input id="name">

  <label>類別</label>
  <select id="group">
    <option value="dog">狗</option>
    <option value="cat">貓</option>
  </select>

  <label>次類別</label>
  <select id="subGroup"></select>

  <label>品種</label>
  <select id="breed"></select>

  <label>年齡</label>
  <input id="age" placeholder="例如：3歲 / 9個月">

  <label>性別</label>
  <select id="gender"><option>男生</option><option>女生</option></select>

  <label>介紹</label>
  <textarea id="intro" rows="3"></textarea>

  <label>上傳圖片（最多 6 張）</label>
  <input id="photos" type="file" accept="image/*" multiple>

  <button id="saveBtn" class="btn">登錄</button>
</section>

<!-- 清單 -->
<section class="card">
  <h3>已登錄動物</h3>
  <input id="search" placeholder="搜尋名字..." />
  <div id="list"></div>
  <div id="empty" style="display:none;color:#666;padding:.6rem 0">查無此動物</div>
</section>

<footer>© 2025 台中簡媽媽狗園｜手機後台</footer>

<!-- 詳細 Modal -->
<div id="detailModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="left-top">
      <button id="mClose" class="fab fab-gray" title="關閉">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="right-top">
      <button id="mDelete" class="fab fab-red" title="刪除">
        <svg class="icon" viewBox="0 0 24 24" fill="#fff"><path d="M3 6h18v2H3V6zm2 3h14v13H5V9zm5 3v7h2v-7h-2zm4 0v7h2v-7h-2zM9 4V2h6v2h5v2H4V4h5z"/></svg>
      </button>
      <button id="mEdit" class="fab fab-green" title="編輯">
        <svg class="icon" viewBox="0 0 24 24" fill="#fff"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>
      </button>
    </div>

    <div class="panel-head">
      <div class="panel-title" id="mTitle">—</div>
    </div>
    <div class="panel-body">
      <div id="mMeta" style="line-height:1.8"></div>

      <div style="margin:.6rem 0 .25rem; color:#444">介紹：</div>
      <div id="mIntro" style="white-space:pre-wrap; color:#333"></div>

      <div style="margin:.8rem 0 .25rem; color:#444">圖片：</div>
      <div id="mGallery" class="gallery"></div>
    </div>
  </div>
</div>

<!-- 圖片預覽 -->
<div id="imgPreview" class="preview" aria-hidden="true">
  <img id="pvImg" alt="預覽">
  <button id="pvClose" class="fab fab-gray close" title="關閉">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
  </button>
</div>

<!-- 編輯小視窗 -->
<div id="editSheet" class="sheet" aria-hidden="true">
  <header><b>編輯動物資料</b></header>
  <div class="body">
    <input type="hidden" id="e_id" />
    <div class="row">
      <div>
        <label>名字</label>
        <input id="e_name" />
      </div>
      <div>
        <label>性別</label>
        <select id="e_gender"><option>男生</option><option>女生</option></select>
      </div>
      <div>
        <label>類別</label>
        <select id="e_group"><option value="dog">狗</option><option value="cat">貓</option></select>
      </div>
      <div>
        <label>次類別</label>
        <select id="e_subGroup"></select>
      </div>
      <div>
        <label>品種</label>
        <select id="e_breed"></select>
      </div>
      <div>
        <label>年齡</label>
        <input id="e_age" />
      </div>
    </div>
    <label>介紹</label>
    <textarea id="e_intro" rows="3"></textarea>

    <div style="margin:.7rem 0 .35rem">已上傳圖片（勾選要刪除）</div>
    <div id="e_gallery" class="gallery"></div>

    <label style="margin-top:.6rem">新增圖片（上限 6 張，超過將忽略）</label>
    <input id="e_files" type="file" accept="image/*" multiple />

    <div class="actions" style="margin-top:1rem">
      <button id="editSave" class="btn" style="flex:1">儲存</button>
      <button id="editCancel" class="btn" style="flex:1; background:#777">取消</button>
    </div>
  </div>
</div>

<script type="module">
/* ================== Firebase ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyADseNNkszDTbwEk4F03_rC0fo4Rnk0iBM",
  authDomain: "pet-adoption-32294.firebaseapp.com",
  projectId: "pet-adoption-32294",
  storageBucket: "pet-adoption-32294.firebasestorage.app",
  messagingSenderId: "102978803311",
  appId: "1:102978803311:web:a7d890096b2b23cad15f9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const stg = getStorage(app);

/* ================== 登出 ================== */
document.getElementById('logoutBtn').onclick = ()=>{
  sessionStorage.removeItem('loggedIn');
  location.href = "login.html";
};

/* ================== 品種資料（比照你原 admin 的結構） ================== */
const breedSets = {
  dog: {
    pure:["博美","貴賓","馬爾濟斯","柴犬","黃金獵犬","臘腸","哈士奇","米格魯","拉布拉多","邊境牧羊犬"],
    mix:["黑色","白色","棕色","花花","虎斑"]
  },
  cat: {
    pure:["美短","英短","藍貓","暹羅貓","曼赤肯","布偶","波斯"],
    mix:["橘貓","黑貓","虎斑貓","三花貓","白貓"]
  }
};
function fillSubGroup($sub, group){
  $sub.innerHTML = (group==='cat')
    ? '<option value="pure">品種貓</option><option value="mix">米克斯</option>'
    : '<option value="pure">品種犬</option><option value="mix">米克斯</option>';
}
function fillBreed($breed, group, sub){
  $breed.innerHTML = '';
  breedSets[group][sub].forEach(x=>{
    const o=document.createElement('option'); o.textContent=x; $breed.appendChild(o);
  });
}

/* 新增表單：連動選單 */
const $group=document.getElementById('group');
const $subGroup=document.getElementById('subGroup');
const $breed=document.getElementById('breed');
function initCreateSelectors(){
  fillSubGroup($subGroup, $group.value);
  fillBreed($breed, $group.value, $subGroup.value || 'pure');
}
$group.onchange=()=>{ fillSubGroup($subGroup, $group.value); fillBreed($breed, $group.value, $subGroup.value='pure'); };
$subGroup.onchange=()=>{ fillBreed($breed, $group.value, $subGroup.value); };
initCreateSelectors();

/* 編輯表單：連動選單 */
const $eg=document.getElementById('e_group');
const $es=document.getElementById('e_subGroup');
const $eb=document.getElementById('e_breed');
$eg.onchange=()=>{ fillSubGroup($es, $eg.value); fillBreed($eb, $eg.value, $es.value='pure'); };
$es.onchange=()=>{ fillBreed($eb, $eg.value, $es.value); };

/* ================== 新增 ================== */
let createFiles = [];
document.getElementById('photos').onchange = e => createFiles = [...e.target.files].slice(0,6);

async function uploadImages(files, id){
  const out=[]; let i=0;
  for(const f of files){
    const path = `images/pets/${id}/${Date.now()}-${i++}-${f.name}`;
    const r = ref(stg, path);
    await uploadBytes(r, f);
    out.push({ url: await getDownloadURL(r), path });
  }
  return out;
}

document.getElementById('saveBtn').onclick = async ()=>{
  const data = {
    name:   document.getElementById('name').value.trim(),
    species: $group.value==='dog'?'狗':'貓',
    group:  $group.value,       // 原始 group 值保留
    subGroup:$subGroup.value,
    breed:  $breed.value,
    age:    document.getElementById('age').value.trim(),
    gender: document.getElementById('gender').value,
    intro:  document.getElementById('intro').value.trim(),
    createdAt: Date.now()
  };
  if(!data.name){ alert("請輸入名字"); return; }
  const dref = await addDoc(collection(db,"pets"), data);
  const imgs = await uploadImages(createFiles, dref.id);
  if(imgs.length) await updateDoc(dref, { images: imgs });
  // reset
  createFiles=[]; document.getElementById('photos').value="";
  ['name','age','intro'].forEach(id=>document.getElementById(id).value="");
  initCreateSelectors();
  await loadList();
  alert("登錄成功");
};

/* ================== 列表 & 檢視 ================== */
let all = [];
const listEl=document.getElementById('list'), emptyEl=document.getElementById('empty');

async function loadList(){
  const snap = await getDocs(query(collection(db,"pets"), orderBy("createdAt","desc")));
  all = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  render(all);
}
function render(items){
  listEl.innerHTML=""; emptyEl.style.display = items.length?"none":"block";
  items.forEach(p=>{
    const row=document.createElement('div');
    row.className='list-row'; row.dataset.id=p.id;
    row.innerHTML = `
      <div class="row-main">
        <b>${p.name || '未命名'}</b>
        <span class="badge">${p.species || '-'}</span>
        <span class="badge">${p.breed || '-'}</span>
        <span class="badge">${p.age || '-'}</span>
        <span class="badge">${p.gender || '-'}</span>
      </div>
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
    `;
    row.addEventListener('click', ()=> openDetail(p.id));
    listEl.appendChild(row);
  });
}

/* 搜尋（依名字） */
document.getElementById('search').oninput=e=>{
  const t=e.target.value.trim().toLowerCase();
  render(all.filter(x=>(x.name||'').toLowerCase().includes(t)));
};

/* ================== 詳細 Modal ================== */
const detailModal=document.getElementById('detailModal');
const mTitle=document.getElementById('mTitle');
const mMeta =document.getElementById('mMeta');
const mIntro=document.getElementById('mIntro');
const mGallery=document.getElementById('mGallery');
const mClose =document.getElementById('mClose');
const mDelete=document.getElementById('mDelete');
const mEdit  =document.getElementById('mEdit');

let currentId=null;

function setOpen(el, open){ el.classList.toggle('open', !!open); }

function openDetail(id){
  const p = all.find(x=>x.id===id); if(!p) return;
  currentId=id;
  mTitle.textContent = p.name || '未命名';
  mMeta.innerHTML = `
    類別：${p.species || '-'}　｜　品種：${p.breed || '-'}　｜　年齡：${p.age || '-'}　｜　性別：${p.gender || '-'}
  `;
  mIntro.textContent = p.intro || '（無）';
  mGallery.innerHTML = (p.images||[]).map(im=>`
    <div class="thumb"><img src="${im.url}" alt=""></div>
  `).join('') || '<div style="color:#888">尚無圖片</div>';
  // 綁定縮圖預覽
  mGallery.querySelectorAll('img').forEach(img=>{
    img.addEventListener('click', e=> openPreview(img.src));
  });
  setOpen(detailModal,true);
}

mClose.onclick = ()=> setOpen(detailModal,false);
detailModal.addEventListener('click', e=>{ if(e.target===detailModal) setOpen(detailModal,false); });

/* 刪除（含圖片） */
mDelete.onclick = async ()=>{
  if(!currentId) return;
  if(!confirm('確定要刪除這筆資料嗎？')) return;
  const p = all.find(x=>x.id===currentId);
  if(p?.images?.length){
    for(const im of p.images){
      try{ await deleteObject(ref(stg, im.path)); }catch{}
    }
  }
  await deleteDoc(doc(db,"pets",currentId));
  setOpen(detailModal,false);
  await loadList();
  alert('已刪除');
};

/* 編輯 → 打開小視窗 */
mEdit.onclick = ()=>{
  if(!currentId) return;
  const p = all.find(x=>x.id===currentId); if(!p) return;
  // 填值
  document.getElementById('e_id').value = p.id;
  document.getElementById('e_name').value = p.name || '';
  document.getElementById('e_gender').value = p.gender || '男生';
  document.getElementById('e_intro').value  = p.intro || '';
  document.getElementById('e_age').value    = p.age || '';
  // 連動：group/sub/breed
  document.getElementById('e_group').value = p.group || (p.species==='狗'?'dog':'cat');
  fillSubGroup(document.getElementById('e_subGroup'), document.getElementById('e_group').value);
  document.getElementById('e_subGroup').value = p.subGroup || 'pure';
  fillBreed(document.getElementById('e_breed'), document.getElementById('e_group').value, document.getElementById('e_subGroup').value);
  document.getElementById('e_breed').value = p.breed || '';
  // 圖片（可勾選刪除）
  const e_gallery = document.getElementById('e_gallery');
  e_gallery.innerHTML = (p.images||[]).map(im=>`
    <label style="position:relative">
      <input type="checkbox" data-path="${im.path}" style="position:absolute;left:6px;top:6px;z-index:2;transform:scale(1.2)">
      <div class="thumb"><img src="${im.url}" alt=""></div>
    </label>
  `).join('') || '<div style="color:#888">尚無圖片</div>';
  setOpen(editSheet,true);
};

/* ================== 圖片預覽 ================== */
const pv=document.getElementById('imgPreview');
const pvImg=document.getElementById('pvImg');
const pvClose=document.getElementById('pvClose');
function openPreview(src){ pvImg.src=src; setOpen(pv,true); }
pvClose.onclick = ()=> setOpen(pv,false);
pv.addEventListener('click', e=>{ if(e.target===pv) setOpen(pv,false); });

/* ================== 編輯小視窗 ================== */
const editSheet=document.getElementById('editSheet');
const editCancel=document.getElementById('editCancel');
const editSave  =document.getElementById('editSave');
const e_files   =document.getElementById('e_files');

let delSet = new Set();
document.getElementById('e_gallery').addEventListener('change', e=>{
  if(e.target.type==='checkbox'){
    if(e.target.checked) delSet.add(e.target.dataset.path);
    else delSet.delete(e.target.dataset.path);
  }
});
editCancel.onclick = ()=>{ delSet.clear(); setOpen(editSheet,false); };

editSave.onclick = async ()=>{
  const id = document.getElementById('e_id').value;
  const dref = doc(db,"pets",id);
  const p = all.find(x=>x.id===id) || {};

  // 1. 刪除勾選的舊圖
  let curImgs = (p.images||[]).slice();
  if(delSet.size){
    const keep = curImgs.filter(im=> !delSet.has(im.path));
    for(const path of delSet){ try{ await deleteObject(ref(stg, path)); }catch{} }
    await updateDoc(dref,{ images: keep });
    curImgs = keep;
    delSet.clear();
  }

  // 2. 上傳新圖
  const addFiles=[...e_files.files].slice(0, Math.max(0, 6 - curImgs.length));
  if(addFiles.length){
    const appended = await uploadImages(addFiles, id);
    curImgs = [...curImgs, ...appended];
    await updateDoc(dref,{ images: curImgs });
  }

  // 3. 更新欄位
  const g = document.getElementById('e_group').value;
  const sub = document.getElementById('e_subGroup').value;
  await updateDoc(dref,{
    name: document.getElementById('e_name').value.trim(),
    gender: document.getElementById('e_gender').value,
    age: document.getElementById('e_age').value.trim(),
    intro: document.getElementById('e_intro').value.trim(),
    group: g,
    subGroup: sub,
    species: g==='dog'?'狗':'貓',
    breed: document.getElementById('e_breed').value
  });

  setOpen(editSheet,false);
  setOpen(detailModal,false);
  await loadList();
  alert('已更新');
};

/* ================== 啟動 ================== */
loadList();
</script>
</body>
</html>
